{% extends "base.html" %}

{% block extrahead %}
    <script type="text/javascript" src="/static/js/jquery.dataTables.min.js"></script>
{% endblock %}

{% load filters %}
{% block bodycontent %}
    {% if nodes_extended %}
        <table id="nodes" class="table">
            <thead>
                <tr>
                    <th class="node_expand"></th>
                    <th class="node_name">Name</th>
                    <th class="node_ip">IP Address</th>
                    <th class="node_env">Environment</th>
                    <th class="node_role">Role</th>
                    <th class="node_recipe">Recipe</th>
                    <th>Tags</th>
                </tr>
            </thead>
            {% for node in nodes_extended %}
                <tr>
                    <td class="control"></td>
                    <td>{{ node.hostname }}</td>
                    <td>{{ node.ipaddress }}</td>
                    <td>{{ node.chef_environment }}</td>
                    <td>{% for entry in node.run_list|get_role_list %}
                        {{ entry }}{% if not forloop.last %}, {% endif %}{% endfor %}
                    </td>
                    <td>{% for entry in node.run_list|get_recipe_list %}
                        {{entry}}{% if not forloop.last %}, {% endif %}{% endfor %}
                    </td>
                    <td class="node_tags">{% for entry in node.tags %}
                        <a href="#" class="btn btn-custom {{entry|get_tag_class}} disabled">{{entry}}</a>{% endfor %}
                    </td>
                </tr>
            {% endfor %}
        </table>
    {% endif %}
{% endblock %}

{% block bodytail %}
<script type="text/javascript">
    /* Node details*/
    function fnFormatNodeDetails (oTable, nTr) {
        var aData = oTable.fnGetData(nTr);
        var node = undefined;
        for(var i=0;i<nodes.length;i++) {
            if (nodes[i].name.substring(0, aData[0].length) == aData[0]) {
                node = nodes[i];
                break;
            }
        }
        var sOut = '<pre>';
        nodeJson = syntaxHighlight(JSON.stringify(node, undefined, 4));
        sOut += nodeJson;
        sOut += '</pre>';
        return sOut;
    }

    function syntaxHighlight(json) {
        json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
            var cls = 'number';
            if (/^"/.test(match)) {
                if (/:$/.test(match)) {
                    cls = 'key';
                } else {
                    cls = 'string';
                }
            } else if (/true|false/.test(match)) {
                cls = 'boolean';
            } else if (/null/.test(match)) {
                cls = 'null';
            }
            return '<span class="' + cls + '">' + match + '</span>';
        });
    }

    $(document).ready(function() {
        nodes = {{nodes|safe}};
        setupClickHandlers();
        var oTable = $('#nodes').dataTable({
            "bPaginate": false,
            "oLanguage": {
                "sSearch": "",
                "sInfo" : "Showing _TOTAL_ nodes",
                "sInfoEmpty": "No nodes found",
                "sInfoFiltered": " (filtering from _MAX_ total)",
                "sZeroRecords": "No nodes to display"
            },
            "sDom": '<"top"if>rt<"bottom"lp><"clear">'
        });
        $('#nodes_filter input').attr("placeholder", "Search");
        $('#nodes_filter input:text').focus();
        $('#nodes td.control').html('<i class="icon-chevron-right"></i>');

        /* Event listener for opening and closing details */
        $('#nodes td.control').live('click', function () {
            var nTr = $(this).parents('tr')[0];
            if (oTable.fnIsOpen(nTr)) {
                $(this).html('<i class="icon-chevron-right"></i>');
                oTable.fnClose(nTr);
            }
            else {
                $(this).html('<i class="icon-chevron-down"></i>');
                oTable.fnOpen(nTr, fnFormatNodeDetails(oTable, nTr), 'details');
            }
        } );
    });
</script>
{% endblock %}
